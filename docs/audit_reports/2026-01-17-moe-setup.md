# System Audit & Compliance Report

**Session ID:** `2026-01-17-setup-moe`
**Status:** Unified Environment Configured (Functionally Complete)
**Compliance Level:** B- (Functional but brittle; AFS Protocol Deviations detected)

This report outlines potential issues, bugs, and deviations from the Agentic File System (AFS) and Source Universe protocols identified during this session.

## 1. AFS Protocol Violations

### A. Persistence & Source of Truth (Critical)
*   **The Violation:** Modified files in `~/src/config/dotfiles` (Zsh) and `~/.config/nvim` (Neovim) directly. While editing the repo (`src/config`) is better than editing `~/.zshrc` directly, scripts were created in `~/bin/` (`claude-picker`, `expert-control`, `hcode-sync`) without verifying if this directory is tracked by the dotfiles repository.
*   **The Risk:** If a dotfiles installer or `stow` command cleans up untracked files, **these scripts will be lost**.
*   **Correction:** These scripts should live in `~/src/config/dotfiles/bin` and be symlinked to `~/bin`.

### B. "Read-Plan-Verify" Failure (JSONC)
*   **The Violation:** Attempted to parse `~/.opencode/opencode.jsonc` with `jq` in the `hcode-sync` script. Failed to recognize that `.jsonc` contains comments, causing standard `jq` to crash.
*   **The Result:** Required two hotfixes. The final solution uses `sed`, which is functional but brittle.
*   **The Protocol:** Verification of file content *and* format is required strictly before writing tools.

## 2. Technical Debt & Potential Bugs

### A. Brittle `sed` Logic in `hcode-sync`
*   **Issue:** The final `hcode-sync` script uses `sed` to replace `"id": "local"` with `"id": "local-expert"`.
*   **Fragility:** Relies on exact string matching. If `opencode.jsonc` is reformatted (e.g., spaces changed), the script will silently fail.
*   **Recommendation:** Use a proper JSONC parser or a `jq` wrapper that strips comments safely.

### B. Dependency Management (`fzf`)
*   **Issue:** `claude-picker` relies on `fzf`. No strict verification if `fzf` is installed or in `$PATH` within the script.
*   **Risk:** Script crash or unpredictable behavior if `fzf` is missing.
*   **Recommendation:** Add `command -v fzf` check.

### C. Backup Overwrites
*   **Issue:** `claude-picker` creates a single backup at `~/.claude.json.safe_backup`.
*   **Risk:** Consecutive operations overwrite the backup with potentially broken state.
*   **Recommendation:** Use timestamped backups (e.g., `.claude.json.backup.$(date +%s)`).

### D. Hardcoded Ports & Paths
*   **Issue:** Hardcoded `localhost:1234` (LM Studio) and `localhost:11434` (Ollama) in multiple scripts (`claude-local`, `expert-control`, Emacs config).
*   **Risk:** Changing ports in GUI breaks the CLI ecosystem.
*   **Recommendation:** Centralize in `.zshrc` or `~/.config/afs/ports.env`.

## 3. Source Universe Alignment

### A. Halext-Code (hcode) Integrity
*   **Status:** Aligned. Respects `opencode.jsonc` structure and model naming conventions.
*   **Warning:** Manual injection of `local-expert` ID overrides default behavior. Ensure `expert-control` is *always* used to load models.

## 4. Immediate Recommendations

1.  **Migrate Scripts:** Move `~/bin/claude-picker`, `~/bin/expert-control`, `~/bin/hcode-sync` to `~/src/config/dotfiles/bin/` and symlink.
2.  **Verify `fzf`:** Ensure `fzf` is installed.
3.  **Test Backup:** Verify `~/.claude.json.safe_backup` validity.
