#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AFS_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
VENV_DIR="${AFS_VENV:-${AFS_ROOT}/.venv}"

if [ -n "${AFS_PYTHON:-}" ]; then
  PYTHON_BIN="$AFS_PYTHON"
elif [ -x "${VENV_DIR}/bin/python" ]; then
  PYTHON_BIN="${VENV_DIR}/bin/python"
  export AFS_VENV="${VENV_DIR}"
else
  PYTHON_BIN="python3"
fi

if [[ "$PYTHON_BIN" == */* ]]; then
  if [ ! -x "$PYTHON_BIN" ]; then
    echo "python not found: ${PYTHON_BIN}" >&2
    exit 1
  fi
else
  if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
    echo "python not found: ${PYTHON_BIN}" >&2
    exit 1
  fi
fi

export AFS_ROOT
export PYTHONPATH="${AFS_ROOT}/src${PYTHONPATH:+:${PYTHONPATH}}"

exec "$PYTHON_BIN" -m afs "$@"
